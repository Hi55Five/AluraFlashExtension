// ========== AUTOMA√á√ÉO ALURA AUTO-REINICIANTE ==========
(function () {
    'use strict';

    // ========== VARI√ÅVEIS GLOBAIS ==========
    let watermarkInitialized = false;
    let frameCount = 0;
    let lastTime = performance.now();
    let fps = 0;
    let ms = 0;
    let isAutomationActive = false;

    // ========== SISTEMA DE ARMAZENAMENTO ==========
    function getStorageKey() {
        return 'aluraAutoRestart_' + window.location.hostname;
    }

    // ========== SISTEMA DE MARCA D'√ÅGUA - CARREGA PRIMEIRO ==========
    function initializeWatermark() {
        if (watermarkInitialized) return;

        const watermark = document.createElement('div');
        watermark.id = 'alura-auto-watermark';
        watermark.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 15px; border-radius: 8px; font-family: Arial, sans-serif; font-size: 12px; z-index: 999999; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); pointer-events: none; user-select: none; text-align: center; min-width: 150px;';

        const fpsElement = document.createElement('div');
        fpsElement.id = 'watermark-fps';
        fpsElement.style.cssText = 'margin-bottom: 5px; font-weight: bold;';
        fpsElement.textContent = 'FPS: 0';

        const msElement = document.createElement('div');
        msElement.id = 'watermark-ms';
        msElement.style.cssText = 'margin-bottom: 5px;';
        msElement.textContent = 'MS: 0';

        const instagramElement = document.createElement('div');
        instagramElement.id = 'watermark-insta';
        instagramElement.style.cssText = 'color: #E1306C; font-size: 11px; font-weight: bold;';
        instagramElement.textContent = '@_zx.lipe_';

        const statusElement = document.createElement('div');
        statusElement.id = 'watermark-status';
        statusElement.style.cssText = 'color: #28a745; font-size: 11px; font-weight: bold;';
        statusElement.textContent = '‚úÖ AUTOMA√á√ÉO ATIVA';

        watermark.appendChild(fpsElement);
        watermark.appendChild(msElement);
        watermark.appendChild(instagramElement);
        watermark.appendChild(statusElement);
        document.body.appendChild(watermark);

        watermarkInitialized = true;
        console.log('üíß Marca d\'√°gua inicializada - FPS, MS e Instagram carregados!');

        // Iniciar loop de atualiza√ß√£o IMEDIATAMENTE
        updateWatermarkStats();
    }

    function updateWatermarkStats() {
        if (!watermarkInitialized) return;

        frameCount++;
        const currentTime = performance.now();
        const deltaTime = currentTime - lastTime;

        if (deltaTime >= 1000) {
            fps = Math.round((frameCount * 1000) / deltaTime);
            ms = deltaTime / frameCount;

            const fpsElement = document.getElementById('watermark-fps');
            const msElement = document.getElementById('watermark-ms');

            if (fpsElement) fpsElement.textContent = 'FPS: ' + fps;
            if (msElement) msElement.textContent = 'MS: ' + Math.round(ms);

            frameCount = 0;
            lastTime = currentTime;
        }

        requestAnimationFrame(updateWatermarkStats);
    }

    // ========== INICIALIZAR MARCA D'√ÅGUA IMEDIATAMENTE ==========
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWatermark);
    } else {
        initializeWatermark();
    }

    // ========== CONFIGURA√á√ÉO INICIAL ==========
    function startAutomation() {
        sessionStorage.setItem(getStorageKey(), 'true');
        isAutomationActive = true;
        console.log('üöÄ AUTOMA√á√ÉO INICIADA - Sobreviver√° aos recarregamentos!');

        // Atualizar status na marca d'√°gua
        const statusElement = document.getElementById('watermark-status');
        if (statusElement) {
            statusElement.textContent = '‚úÖ AUTOMA√á√ÉO ATIVA';
            statusElement.style.color = '#28a745';
        }

        executeAutomation();
    }

    function stopAutomation() {
        sessionStorage.setItem(getStorageKey(), 'false');
        isAutomationActive = false;
        console.log('üõë AUTOMA√á√ÉO PARADA - N√£o reiniciar√° mais');

        // Atualizar status na marca d'√°gua
        const statusElement = document.getElementById('watermark-status');
        if (statusElement) {
            statusElement.textContent = '‚èπÔ∏è AUTOMA√á√ÉO PARADA';
            statusElement.style.color = '#dc3545';
        }

        // N√£o remover a marca d'√°gua completamente, s√≥ atualizar o status
    }

    // ========== FUN√á√ÉO DE DEBUG DA DESCRIPTOGRAFIA ==========
    function debugDescriptografiaBlocos() {
        console.log("üîç DEBUG - DESCRIPTOGRAFIA DE BLOCOS");
        console.log("========================================");

        try {
            const blocksContainer = document.querySelector(".blocks");
            if (!blocksContainer) {
                console.log("‚ùå Container de blocos n√£o encontrado");
                return;
            }

            const correctOrderBase64 = blocksContainer.getAttribute("data-correct-order");
            console.log("1Ô∏è‚É£ BASE64 ORIGINAL:");
            console.log(correctOrderBase64);
            console.log("");

            const primeiraDecodificacao = atob(correctOrderBase64);
            console.log("2Ô∏è‚É£ PRIMEIRA DECODIFICA√á√ÉO:");
            console.log(primeiraDecodificacao);
            console.log("");

            const decodificacaoFinal = atob(primeiraDecodificacao);
            console.log("3Ô∏è‚É£ DECODIFICA√á√ÉO FINAL:");
            console.log(decodificacaoFinal);
            console.log("");

            // ========== FUN√á√ÉO DE DEBUG AVAN√áADO ==========
            window.debugBlockMatching = function () {
                console.log("üîç DEBUG AVAN√áADO - MATCHING DE BLOCOS");
                console.log("========================================");

                const blocksContainer = document.querySelector('.blocks');
                if (!blocksContainer) {
                    console.log("‚ùå Container de blocos n√£o encontrado");
                    return;
                }

                const correctOrderBase64 = blocksContainer.getAttribute('data-correct-order');
                const primeiraDecodificacao = atob(correctOrderBase64);
                const decodificacaoFinal = atob(primeiraDecodificacao);

                const correctedSequence = decodificacaoFinal.split(',').map(texto => {
                    return texto
                        .replace(/\x98/g, "'")
                        .replace(/\x99/g, "'")
                        .replace(/√¢\x80\x9C/g, '"')
                        .replace(/√¢\x80\x9D/g, '"')
                        .replace(/√¢\x80¬ú/g, '"')
                        .replace(/√¢\x80/g, '')
                        .replace(/√É¬∫/g, "√∫")
                        .replace(/√É¬°/g, "√°")
                        .replace(/√É¬£/g, "√£")
                        .replace(/√É¬ß/g, "√ß")
                        .replace(/√É¬©/g, "√©")
                        .replace(/√É¬≠/g, "√≠")
                        .replace(/√É¬≥/g, "√≥")
                        .replace(/√É¬µ/g, "√µ")
                        .replace(/√É¬™/g, "√™")
                        .replace(/√É¬¢/g, "√¢")
                        .trim();
                }).filter(texto => texto !== "");

                const availableBlocks = Array.from(document.querySelectorAll('#sortBlocksOrigin .block'));

                console.log("üéØ SEQU√äNCIA CORRETA vs BLOCOS DISPON√çVEIS:");
                correctedSequence.forEach((seqText, index) => {
                    const cleanSeqText = seqText.replace(/[',()]/g, '').replace(/\s+/g, ' ').trim().toLowerCase();

                    const matchingBlocks = availableBlocks.filter(block => {
                        const blockText = block.getAttribute('data-text');
                        const cleanBlockText = blockText.replace(/[',()]/g, '').replace(/\s+/g, ' ').trim().toLowerCase();
                        return cleanBlockText.includes(cleanSeqText) || cleanSeqText.includes(cleanBlockText);
                    });

                    console.log(`   ${index + 1}. "${seqText}" ‚Üí ${matchingBlocks.length} correspond√™ncias:`);
                    matchingBlocks.forEach(block => {
                        console.log(`      - "${block.getAttribute('data-text')}"`);
                    });
                });
            };

            // CORRE√á√ÉO COMPLETA PARA CARACTERES ESPECIAIS
            const sequenciaCorreta = decodificacaoFinal.split(",").map(texto => {
                return texto
                    // Corrigir aspas simples curvas (' ')
                    .replace(/\x98/g, "'")
                    .replace(/\x99/g, "'")
                    .replace(/√¢\x80\x9C/g, '"')
                    .replace(/√¢\x80\x9D/g, '"')
                    .replace(/√¢\x80¬ú/g, '"')
                    .replace(/√¢\x80/g, '')
                    // Corrigir caracteres acentuados
                    .replace(/√É¬∫/g, "√∫")
                    .replace(/√É¬°/g, "√°")
                    .replace(/√É¬£/g, "√£")
                    .replace(/√É¬ß/g, "√ß")
                    .replace(/√É¬©/g, "√©")
                    .replace(/√É¬≠/g, "√≠")
                    .replace(/√É¬≥/g, "√≥")
                    .replace(/√É¬µ/g, "√µ")
                    .replace(/√É¬™/g, "√™")
                    .replace(/√É¬¢/g, "√¢")
                    .trim();
            }).filter(texto => texto !== ""); // Remover strings vazias

            console.log("4Ô∏è‚É£ SEQU√äNCIA CORRETA (Array):");
            console.log(sequenciaCorreta);
            console.log("");

            console.log("5Ô∏è‚É£ ORDEM NUMERADA:");
            sequenciaCorreta.forEach((bloco, index) => {
                console.log(`   ${index + 1}. ${bloco}`);
            });
            console.log("========================================");

            // MOSTRAR COMPARA√á√ÉO COM OS BLOCOS REAIS
            console.log("üîç COMPARA√á√ÉO COM BLOCOS DISPON√çVEIS:");
            const blocosDisponiveis = document.querySelectorAll("#sortBlocksOrigin .block");
            blocosDisponiveis.forEach((bloco, index) => {
                console.log(`   Bloco ${index + 1}: "${bloco.getAttribute("data-text")}"`);
            });

            console.log("üéØ RESULTADO FINAL CORRIGIDO:");
            sequenciaCorreta.forEach((bloco, index) => {
                console.log(`   ${index + 1}. ${bloco}`);
            });

            // VERIFICAR SE A ORDEM EST√Å CORRETA
            console.log("üîç VERIFICA√á√ÉO DA ORDEM:");
            const blocosReais = Array.from(document.querySelectorAll("#sortBlocksOrigin .block"));
            const ordemCorreta = sequenciaCorreta.map(textoDecodificado => {
                return blocosReais.find(bloco =>
                    bloco.getAttribute("data-text") === textoDecodificado
                );
            }).filter(bloco => bloco !== undefined);

            if (ordemCorreta.length === sequenciaCorreta.length) {
                console.log("‚úÖ ORDEM COMPAT√çVEL COM OS BLOCOS!");
            } else {
                console.log("‚ö†Ô∏è  POSS√çVEL INCOMPATIBILIDADE NA ORDEM");
            }

            console.log("‚úÖ DESCRIPTOGRAFIA CONCLU√çDA!");

        } catch (error) {
            console.log("‚ùå ERRO NA DESCRIPTOGRAFIA:", error);
        }
    }

    // ========== DETEC√á√ÉO DE ATIVIDADE ==========
    function detectActivityType() {
        if (document.querySelector('.vjs-big-play-button, .vjs-play-control, video')) return 'video';
        if (document.querySelector('button.task-actions-button-showOpinion')) return 'texto-opiniao';
        if (document.querySelector('.alternativeList-item-input')) return 'multipla-escolha';
        if (document.querySelector('.blocks') && document.getElementById('sortBlocksOrigin')) return 'ordenar-blocos';
        if (document.getElementById('project-link')) return 'link-projeto';
        if (document.querySelector('a.task-actions-button-next')) return 'texto-imagem';
        return 'desconhecida';
    }

    // ========== FUN√á√ïES DE AUTOMA√á√ÉO ==========
    function autoClickVideo() {
        console.log('üé¨ Processando V√çDEO...');

        const playButton = document.querySelector('.vjs-big-play-button, .vjs-play-control');
        if (playButton) {
            playButton.click();
            console.log('‚úÖ Play clicado');
        }

        setTimeout(() => {
            goToNextActivity();
        }, 4000);
    }

    function autoClickTextoImagem() {
        console.log('üì∑ Processando TEXTO COM IMAGEM...');
        goToNextActivity();
    }

    function autoClickTextoOpiniao() {
        console.log('üí¨ Processando TEXTO COM OPINI√ÉO...');

        const opinionButton = document.querySelector('button.task-actions-button-showOpinion') || Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('Ver opini√£o do instrutor'));

        if (opinionButton) {
            opinionButton.click();
            console.log('‚úÖ Opini√£o clicada');
        }

        setTimeout(() => {
            goToNextActivity();
        }, 2000);
    }

    function autoClickMultiplaEscolha() {
        console.log('üîò Processando M√öLTIPLA ESCOLHA...');

        const alternatives = document.querySelectorAll('.alternativeList-item-input');
        if (alternatives.length > 0) {
            alternatives.forEach((alt, index) => {
                setTimeout(() => {
                    alt.click();
                    console.log('‚úÖ Alternativa ' + (index + 1) + ' clicada');
                }, index * 300);
            });

            setTimeout(() => {
                goToNextActivity();
            }, alternatives.length * 300 + 2000);
        } else {
            setTimeout(goToNextActivity, 2000);
        }
    } function autoClickMultiplaEscolha() {
        console.log('üîò Processando M√öLTIPLA ESCOLHA...');

        const alternatives = document.querySelectorAll('.alternativeList-item-input');
        console.log(`üìã Encontradas ${alternatives.length} alternativas`);

        if (alternatives.length > 0) {
            // Clique em TODAS as alternativas sequencialmente
            alternatives.forEach((alt, index) => {
                setTimeout(() => {
                    if (alt && alt.parentElement) { // Verificar se o elemento ainda existe
                        alt.click();
                        console.log(`‚úÖ Alternativa ${index + 1} clicada`);

                        // Verificar se foi marcada como selecionada
                        if (alt.checked || alt.getAttribute('aria-checked') === 'true') {
                            console.log(`‚òëÔ∏è Alternativa ${index + 1} selecionada com sucesso`);
                        }
                    }
                }, index * 500); // 500ms entre cada clique
            });

            // Aguardar um pouco mais antes de ir para a pr√≥xima
            setTimeout(() => {
                console.log('üîÑ Indo para pr√≥xima atividade...');
                goToNextActivity();
            }, alternatives.length * 500 + 2000);

        } else {
            console.log('‚ùå Nenhuma alternativa encontrada');
            setTimeout(goToNextActivity, 2000);
        }
    }

    function autoClickOrdenarBlocos() {
        console.log('üß© Processando ORDENAR BLOCOS...');

        try {
            const blocksContainer = document.querySelector('.blocks');
            if (blocksContainer) {
                const correctOrderBase64 = blocksContainer.getAttribute('data-correct-order');
                const primeiraDecodificacao = atob(correctOrderBase64);
                const decodificacaoFinal = atob(primeiraDecodificacao);

                // USANDO A MESMA CORRE√á√ÉO DA FUN√á√ÉO DEBUG
                const correctedSequence = decodificacaoFinal.split(',').map(texto => {
                    return texto
                        .replace(/\x98/g, "'")
                        .replace(/\x99/g, "'")
                        .replace(/√¢\x80\x9C/g, '"')
                        .replace(/√¢\x80\x9D/g, '"')
                        .replace(/√¢\x80¬ú/g, '"')
                        .replace(/√¢\x80/g, '')
                        .replace(/√É¬∫/g, "√∫")
                        .replace(/√É¬°/g, "√°")
                        .replace(/√É¬£/g, "√£")
                        .replace(/√É¬ß/g, "√ß")
                        .replace(/√É¬©/g, "√©")
                        .replace(/√É¬≠/g, "√≠")
                        .replace(/√É¬≥/g, "√≥")
                        .replace(/√É¬µ/g, "√µ")
                        .replace(/√É¬™/g, "√™")
                        .replace(/√É¬¢/g, "√¢")
                        .trim();
                }).filter(texto => texto !== "");

                console.log('‚úÖ SEQU√äNCIA CORRETA DECODIFICADA:');
                correctedSequence.forEach((bloco, index) => {
                    console.log(`   ${index + 1}. ${bloco}`);
                });

                // Resetar se necess√°rio
                const destination = document.getElementById('sortBlocksDestination');
                if (destination && destination.children.length > 0) {
                    const resetButton = document.getElementById('tryAgain');
                    if (resetButton) {
                        resetButton.click();
                        console.log('üîÑ Blocos resetados');
                        // Aguardar o reset completar
                        setTimeout(() => {
                            executeBlockOrdering(correctedSequence);
                        }, 1000);
                        return;
                    }
                }

                executeBlockOrdering(correctedSequence);

            } else {
                console.log('‚ùå Container de blocos n√£o encontrado');
                setTimeout(goToNextActivity, 3000);
            }
        } catch (error) {
            console.log('‚ùå Erro em ordenar blocos:', error);
            setTimeout(goToNextActivity, 3000);
        }

        // FUN√á√ÉO AUXILIAR PARA ORDENAR BLOCOS
        function executeBlockOrdering(correctedSequence) {
            console.log('üñ±Ô∏è Iniciando clique nos blocos...');

            // Obter todos os blocos dispon√≠veis
            const availableBlocks = Array.from(document.querySelectorAll('#sortBlocksOrigin .block'));
            console.log(`üì¶ Blocos dispon√≠veis: ${availableBlocks.length}`);

            // Array para controlar quais blocos j√° foram clicados
            const clickedBlocks = new Set();

            // Mapear a sequ√™ncia correta para os blocos reais - COMPARA√á√ÉO FLEX√çVEL
            const sequenceToClick = correctedSequence.map(blockText => {
                // Limpar o texto para compara√ß√£o
                const cleanBlockText = blockText
                    .replace(/[',()]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .toLowerCase();

                console.log(`üîç Procurando: "${blockText}" (limpo: "${cleanBlockText}")`);

                // Encontrar o bloco que corresponde ao texto (compara√ß√£o flex√≠vel)
                const matchingBlock = availableBlocks.find(block => {
                    // Pular blocos j√° clicados
                    if (clickedBlocks.has(block)) {
                        return false;
                    }

                    const blockDataText = block.getAttribute('data-text');
                    const cleanBlockDataText = blockDataText
                        .replace(/[',()]/g, '')
                        .replace(/\s+/g, ' ')
                        .trim()
                        .toLowerCase();

                    console.log(`   Comparando com: "${blockDataText}" (limpo: "${cleanBlockDataText}")`);

                    // Compara√ß√£o flex√≠vel - verifica se um cont√©m o outro
                    const isMatch = cleanBlockDataText.includes(cleanBlockText) ||
                        cleanBlockText.includes(cleanBlockDataText) ||
                        cleanBlockDataText === cleanBlockText;

                    return isMatch;
                });

                if (matchingBlock) {
                    console.log(`‚úÖ Encontrado: "${matchingBlock.getAttribute('data-text')}"`);
                    // Marcar como clicado para evitar duplica√ß√£o
                    clickedBlocks.add(matchingBlock);
                    return {
                        element: matchingBlock,
                        originalText: blockText,
                        foundText: matchingBlock.getAttribute('data-text')
                    };
                } else {
                    console.log(`‚ùå N√£o encontrado: "${blockText}"`);
                    return null;
                }
            }).filter(item => item !== null);

            console.log(`üéØ Sequ√™ncia para clicar: ${sequenceToClick.length} blocos de ${correctedSequence.length}`);

            if (sequenceToClick.length === 0) {
                console.log('‚ùå Nenhum bloco compat√≠vel encontrado, tentando m√©todo alternativo...');
                tryAlternativeMethod();
                return;
            }

            // Verificar se temos blocos duplicados
            const uniqueBlocks = new Set();
            const finalSequence = sequenceToClick.filter(item => {
                const key = item.element.getAttribute('data-text');
                if (uniqueBlocks.has(key)) {
                    console.log(`‚ö†Ô∏è Removendo duplicata: "${key}"`);
                    return false;
                }
                uniqueBlocks.add(key);
                return true;
            });

            console.log(`üéØ Sequ√™ncia final sem duplicatas: ${finalSequence.length} blocos`);

            // Clique sequencial nos blocos encontrados
            finalSequence.forEach((item, index) => {
                setTimeout(() => {
                    if (item.element && item.element.parentElement) {
                        item.element.click();
                        console.log(`‚úÖ Bloco ${index + 1} clicado: "${item.foundText}" (original: "${item.originalText}")`);

                        // Verificar se o bloco foi movido
                        setTimeout(() => {
                            if (!item.element.parentElement || item.element.parentElement.id !== 'sortBlocksOrigin') {
                                console.log(`üì§ Bloco "${item.foundText}" movido com sucesso`);
                            }
                        }, 500);
                    } else {
                        console.log(`‚ö†Ô∏è Bloco ${index + 1} n√£o dispon√≠vel`);
                    }
                }, index * 1200); // Reduzi para 1.2s entre cliques
            });

            // Submeter ap√≥s clicar em todos os blocos
            setTimeout(() => {
                const submitButton = document.getElementById('submitBlocks');
                if (submitButton) {
                    console.log('üì§ Submetendo resposta...');
                    submitButton.click();

                    // Verificar se foi bem sucedido
                    setTimeout(() => {
                        const errorMessage = document.querySelector('.error-message, .text-danger');
                        if (errorMessage) {
                            console.log('‚ùå Erro na submiss√£o, tentando novamente...');
                            setTimeout(goToNextActivity, 2000);
                        } else {
                            console.log('‚úÖ Resposta submetida com sucesso!');
                            setTimeout(goToNextActivity, 3000);
                        }
                    }, 2000);
                } else {
                    console.log('‚ùå Bot√£o de submit n√£o encontrado');
                    setTimeout(goToNextActivity, 3000);
                }
            }, finalSequence.length * 1200 + 1000);
        }

        // M√âTODO ALTERNATIVO SE A COMPARA√á√ÉO FLEX√çVEL FALHAR
        function tryAlternativeMethod() {
            console.log('üîÑ Tentando m√©todo alternativo...');

            const availableBlocks = Array.from(document.querySelectorAll('#sortBlocksOrigin .block'));

            // Se temos 4 blocos e 4 na sequ√™ncia, clica na ordem dos blocos dispon√≠veis
            if (availableBlocks.length === correctedSequence.length) {
                console.log('üéØ Clique sequencial nos blocos dispon√≠veis');

                availableBlocks.forEach((block, index) => {
                    setTimeout(() => {
                        block.click();
                        console.log(`‚úÖ Bloco ${index + 1} clicado: "${block.getAttribute('data-text')}"`);
                    }, index * 1500);
                });

                // Submeter
                setTimeout(() => {
                    const submitButton = document.getElementById('submitBlocks');
                    if (submitButton) {
                        submitButton.click();
                        setTimeout(goToNextActivity, 3000);
                    }
                }, availableBlocks.length * 1500 + 1000);
            } else {
                console.log('‚ùå M√©todo alternativo n√£o aplic√°vel, indo para pr√≥xima...');
                setTimeout(goToNextActivity, 3000);
            }
        }
    }

    function autoClickLinkProjeto() {
        console.log('üîó Processando LINK DE PROJETO...');

        const projectLinkInput = document.getElementById('project-link');
        if (projectLinkInput) {
            // Preencher o link
            projectLinkInput.value = 'https://cursos.alura.com.br/course/introducao-python-desafios-programacao/task/198807';

            // Disparar eventos para ativar valida√ß√£o
            ['input', 'change', 'blur'].forEach(eventType => {
                projectLinkInput.dispatchEvent(new Event(eventType, { bubbles: true }));
            });

            console.log('‚úÖ Link preenchido');

            // Aguardar um pouco para a valida√ß√£o processar
            setTimeout(() => {
                const submitButton = document.getElementById('linkSubmit');
                if (submitButton) {
                    // Remover disabled se existir
                    if (submitButton.disabled) {
                        submitButton.disabled = false;
                        console.log('üîì Bot√£o habilitado');
                    }

                    // Clicar no bot√£o de enviar
                    submitButton.click();
                    console.log('‚úÖ Link enviado');

                    // AGUARDAR A P√ÅGINA PROCESSAR E IR PARA PR√ìXIMA ATIVIDADE
                    setTimeout(() => {
                        console.log('üîÑ Indo para pr√≥xima atividade...');
                        goToNextActivity();
                    }, 3000); // 3 segundos ap√≥s enviar o link

                } else {
                    console.log('‚ùå Bot√£o de envio n√£o encontrado, indo para pr√≥xima...');
                    setTimeout(goToNextActivity, 2000);
                }
            }, 1500); // 1.5 segundos ap√≥s preencher o link

        } else {
            console.log('‚ùå Campo de link n√£o encontrado, indo para pr√≥xima...');
            setTimeout(goToNextActivity, 2000);
        }
    }

    // ========== FUN√á√ÉO PARA PR√ìXIMA ATIVIDADE ==========
    function goToNextActivity() {
        if (!isAutomationActive) return;

        console.log('üîÑ Procurando pr√≥xima atividade...');

        const nextButton = document.querySelector('a.task-actions-button-next, a[href*="/next"]') || Array.from(document.querySelectorAll('a, button')).find(el => el.textContent.includes('Pr√≥xima Atividade'));

        if (nextButton) {
            console.log('‚úÖ Indo para pr√≥xima atividade...');
            sessionStorage.setItem(getStorageKey(), 'true');
            nextButton.click();
        } else {
            console.log('‚ùå Bot√£o pr√≥ximo n√£o encontrado, tentando novamente em 5s...');
            setTimeout(executeAutomation, 5000);
        }
    }

    // ========== EXECU√á√ÉO PRINCIPAL ==========
    function executeAutomation() {
        if (!isAutomationActive) return;

        const activityType = detectActivityType();
        console.log('üìä Atividade detectada: ' + activityType.toUpperCase());

        switch (activityType) {
            case 'video':
                autoClickVideo();
                break;
            case 'texto-imagem':
                autoClickTextoImagem();
                break;
            case 'texto-opiniao':
                autoClickTextoOpiniao();
                break;
            case 'multipla-escolha':
                autoClickMultiplaEscolha();
                break;
            case 'ordenar-blocos':
                autoClickOrdenarBlocos();
                break;
            case 'link-projeto':
                autoClickLinkProjeto();
                break;
            default:
                console.log('‚è≥ Nenhuma atividade detectada, tentando novamente em 3s...');
                setTimeout(executeAutomation, 3000);
        }
    }

    // ========== COMUNICA√á√ÉO COM POPUP ==========
    chrome.runtime.onMessage.addListener(function (request, sender, sendResponse) {
        console.log('üì© Mensagem recebida:', request.action);

        switch (request.action) {
            case "startAutomation":
                startAutomation();
                sendResponse({ success: true, status: "started" });
                break;

            case "stopAutomation":
                stopAutomation();
                sendResponse({ success: true, status: "stopped" });
                break;

            case "getStatus":
                sendResponse({
                    isActive: isAutomationActive,
                    hasWatermark: watermarkInitialized
                });
                break;

            case "debugDescriptografia":
                debugDescriptografiaBlocos();
                sendResponse({ success: true, status: "debug_executed" });
                break;

            default:
                sendResponse({ success: false, error: "A√ß√£o desconhecida" });
        }

        return true;
    });

    // ========== CONTROLES GLOBAIS (para debug) ==========
    window.startAluraAutomation = startAutomation;
    window.stopAluraAutomation = stopAutomation;
    window.debugDescriptografiaBlocos = debugDescriptografiaBlocos;

    // ========== VERIFICAR AUTOMA√á√ÉO EXISTENTE ==========
    if (sessionStorage.getItem(getStorageKey()) === 'true') {
        console.log('üîÑ AUTOMA√á√ÉO REINICIADA - Continuando...');
        isAutomationActive = true;
        setTimeout(() => {
            executeAutomation();
        }, 2000);
    }

    // ========== INICIAR AUTOMATICAMENTE ==========
    console.log('üéÆ EXTENS√ÉO ALURA AUTOMA√á√ÉO CARREGADA!\n\nComandos no console:\n‚Ä¢ startAluraAutomation() - Iniciar\n‚Ä¢ stopAluraAutomation() - Parar\n‚Ä¢ debugDescriptografiaBlocos() - Debug da descriptografia\n\nOu use o popup da extens√£o!');

})();